--product-report



with base_query as (
select p.product_key,p.product_name,p.category,p.subcategory,p.cost,f.order_date,f.order_number,f.customer_key,f.sales_amount,f.quantity	
from gold_1.dim_products p
left join gold_1.fact_sales f on p.product_key=f.product_key
where f.order_date is   not null
),cte2 as(
select 
product_key,product_name,category,subcategory,cost,
DATEDIFF(month,min(order_date),max(order_date)) as lifespan,
max(order_date) as last_order_date,
count( distinct order_number) as total_orders,
count(distinct customer_key) as total_customers,
sum(sales_amount) as total_revenue,
sum(quantity) as total_quantity,
avg((sales_amount)/(quantity))as avg_selling_price
from base_query
group by product_key,product_name,category,subcategory,cost
)
select
product_key,product_name,category,subcategory,cost,
last_order_date,
DATEDIFF(month,last_order_date,GETDATE()) as receny_in_months,
case when total_revenue>50000 then 'highperformer'
when total_revenue>10000 then 'midperformer'
else 'lowperformer'
end as product_segment,lifespan,total_orders,total_customers,total_quantity,avg_selling_price
total_revenue,
case when total_revenue=0 then 0
else total_revenue/total_orders  end as avg_order_revenue,
case when lifespan=0 then total_revenue
else total_revenue/lifespan
 end as avg_monthly_revenue
from cte2
--customer_report

create view  gold_1.report_customers as
with base_query as(
select 
c.customer_key,c.customer_number,
CONCAT(c.first_name,'',c.last_name) as customer_name,
DATEDIFF(year,c.birthdate,GETDATE()) as age,
f.order_date,
f.order_number,
f.sales_amount,
f.quantity
from gold_1.dim_customers c
left join gold_1.fact_sales f
on f.customer_key=c.customer_key
where f.order_date is not null
),customer_agg as(
select
customer_key,customer_number,customer_name,age,
count(distinct order_number) as total_orders,
sum(sales_amount) as total_sales,
sum(quantity) as total_quantity,
DATEDIFF(MONTH,min(order_date),max(order_date)) as lifespan,
max(order_date) as last_order_date
from base_query
group by customer_key,customer_number,customer_name,age

)

select
customer_key,customer_number,customer_name,age,
case when age<20 then 'under-20'
when age between 20 and 29 then '20-29'
when age between 30 and 39 then '30-39'
when age between 40 and 49 then '40-49'
else '50 and above'
end as age_group
, case when lifespan >=12 and total_sales>=5000 then 'vip'
 when lifespan >=12 and total_sales<=5000 then 'regular'
 else 'new'
 end as customer_segment,
 last_order_date,
 DATEDIFF(month,last_order_date,GETDATE()) as receny,
 total_orders,total_sales,total_quantity,lifespan,
 case when total_sales=0 then 0
 else total_sales/total_orders end as avg_order_value,
 case when lifespan=0 then total_sales
 else total_sales/lifespan  end as avg_monthly_spend
from customer_agg


select * from gold_1.report_customers
